var data=[],startPoints=0,totalPoints=100,chartArray={battery:[],house:[],solar:[],grid:[],date:[]},current={solar:"",battery:"",grid:"",house:""},maxValue=0,minValue=-500,color={battery:"#8BC34A",house:"#607D8B",solar:"#ffa600",grid:"#adadad"},ani=1,maxSolar_kW=10.725,gridCost=.18085128,nodeAPIaddr="http://10.0.10.202:3301/api";function reDraw(){var t=$("#pie_chart").width();$("#pie_chart").css("height",t)}function getData(t,r){var a=nodeAPIaddr;null==t?$.getJSON(a,function(t){r(t)}):(a=[a+t],$.getJSON(a,function(t){r(t)}))}function streamPWApi(t,r){"undefined"==t&&(t="meters");var a=[nodeAPIaddr+"/stream/"+t];"meters"==t?$.getJSON(a,function(t){var a=t.load.instant_power/1e3;$("#house-consumption .number").text(a.toFixed(3)+" kW"),r(t)}):$.getJSON(a,function(t){r(t)})}function initCharts(){$(".chart.chart-bar").sparkline(void 0,{type:"bar",barColor:"rgba(0, 0, 0, 0.15)",negBarColor:"rgba(0, 0, 0, 0.15)",barWidth:"8px",height:"34px"}),streamPWApi("system_status",function(t){var r=t.percentage,a=100-r;$("#battery-level .chart.chart-pie").text(a+","+r),$("#battery-level .number").text(r.toFixed(1)+" %"),$(".chart.chart-pie").sparkline(void 0,{type:"pie",height:"50px",sliceColors:["rgba(0,0,0,0.10)","rgba(0,0,0,0.25)"]})})}function buildChart(){initCharts(),streamPWApi("meters",function(t){startPoints>totalPoints&&(chartArray.battery.shift(),chartArray.house.shift(),chartArray.solar.shift(),chartArray.grid.shift()),chartArray.battery.push([startPoints,t.battery.instant_power]),chartArray.house.push([startPoints,t.load.instant_power]),chartArray.solar.push([startPoints,t.solar.instant_power]),chartArray.grid.push([startPoints,t.site.instant_power]),current.solar=t.solar.instant_power/1e3,current.battery=t.battery.instant_power/1e3,current.grid=t.site.instant_power/1e3,current.house=t.load.instant_power/1e3;var r,a,e=[];for(n=0;n<chartArray.house.length;n++)e.push(chartArray.battery[n][1]),e.push(chartArray.solar[n][1]),e.push(chartArray.grid[n][1]);maxValue=Math.max.apply(null,e)+100,minValue=Math.min.apply(null,e)-100,startPoints++,a=[{data:(r=chartArray).battery,label:"PWall "+current.battery.toFixed(2)+"kW",color:color.battery},{data:r.grid,label:"Grid "+current.grid.toFixed(2)+"kW",color:color.grid},{data:r.solar,label:"Solar "+current.solar.toFixed(2)+"kW",color:color.solar}],$.plot("#tracking_chart",a,{crosshair:{mode:"x"},grid:{hoverable:!0,autoHighlight:!1,borderWidth:1,tickColor:"#474747"},yaxis:{color:"#ccc",min:minValue,max:maxValue}}),$("#tracking_chart .legendLabel").each(function(){$(this).css("width",$(this).width())}),piePower(current),batteryStatus(current),houseOutput(chartArray,startPoints)})}function batteryStatus(t){var r=t.battery;r<-.02?($("#battery-status .number").text("Charging"),$("#battery-status .material-icons").addClass("battery_charging")):r>=-.02&&r<=.02?($("#battery-status .number").text("Standby"),$("#battery-status .material-icons").addClass("battery-full")):r>.02&&($("#battery-status .number").text("Discharging"),$("#battery-status .material-icons").addClass("battery-full"),ani<7?(ani++,$("#battery-status .material-icons").addClass("animate"+ani)):($("#battery-status .material-icons").removeClass(function(t,r){return(r.match(/(^|\s)animate\S+/g)||[]).join(" ")}),ani=1),$("#battery-status .material-icons").addClass("battery-discharging"))}function houseOutput(t,r){var a;function e(t,r){return t+r}(t=t.house).length==r?a=t.reduce(e):a==t.length+100?a.push(t.reduce(e)):a=0}function piePower(t){reDraw();for(var r=[t.solar.toFixed(2),t.battery.toFixed(2),t.grid.toFixed(2)],a=["Solar","Battery","Grid"],e=[color.solar,color.battery,color.grid],s=0;s<3;s++)r[s]<0?r[s]=0:r[s]>100&&(r[s]=100),r[s]={label:a[s],data:r[s],color:e[s]};if(t.solar>0){$(".solar-breakdown").css("display","block");var o=t.solar/maxSolar_kW*100;l(".solar .progress-bar",o=(o=Math.abs(o)).toFixed(1)+"%")}if(t.solar>t.house){if(t.battery<0){var i=t.battery/t.solar*100;l(".battery .progress-bar",i=(i=Math.abs(i)).toFixed(1)+"%")}else l(".battery .progress-bar","0");if(t.house<t.solar){var n=t.house/t.solar*100;l(".house .progress-bar",n=(n=Math.abs(n)).toFixed(1)+"%")}else l(".house .progress-bar","0");if(t.grid<0){var u=t.grid/t.solar*100;l(".grid .progress-bar",u=(u=Math.abs(u)).toFixed(1)+"%")}else l(".grid .progress-bar","0")}else $(".solar-breakdown").css("display","none");function l(t,r){$(".solar-breakdown").find(t).css("width",r)}$.plot("#pie_chart",r,{series:{pie:{show:!0,radius:1,innerRadius:.8,label:{show:!1,radius:.75,formatter:function(t,r){return'<div style="font-size:8pt; text-align:center; padding:2px; color:white;">'+t+"<br/>"+Math.round(r.percent)+"%</div>"},background:{opacity:.5}},stroke:{width:0}}},legend:{show:!1}})}function getTodayData(t){(new Date).getHours();var r={solar:{sum:0,count:0,hours:0,Whr:0},battery:{sum:0,count:0,hours:0,Whr:0},grid:{sum:0,count:0,hours:0,Whr:0},house:{sum:0,count:0,hours:0,Whr:0}};getData(function(t){for(n=0;n<t.length;n++)r.solar.sum=r.solar.sum+Number(t[n].solar),r.house.sum=r.house.sum+Number(t[n].house),r.grid.sum=r.grid.sum+Number(t[n].grid),r.battery.sum=r.battery.sum+Number(t[n].battery),Number(t[n].solar)>0&&r.solar.count++,0!=Number(t[n].house)&&r.house.count++,0!=Number(t[n].grid)&&r.grid.count++,0!=Number(t[n].battery)&&r.battery.count++;var a=i("house"),e=i("grid"),s=(a-e)*gridCost,o=gridCost*e;function i(t){return r[t].whr=r[t].sum/r[t].count,r[t].whr=r[t].whr*(r[t].count/60),r[t].whr=r[t].whr/1e3,r[t].whr}$("#cost-output .number").text("Grid Cost: $"+o.toFixed(2)+"   Savings: $"+s.toFixed(2))}),null!=t&&t()}$(function(){setTimeout(function(){$(".page-loader-wrapper").fadeOut()},50),setInterval(buildChart,1e3),setInterval(getTodayData,1e3),$(window).resize(reDraw())});